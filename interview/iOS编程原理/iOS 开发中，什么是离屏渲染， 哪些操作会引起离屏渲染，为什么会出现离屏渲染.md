# iOS 开发中，什么是离屏渲染， 哪些操作会引起离屏渲染，为什么会出现离屏渲染

在iOS开发中，“离屏渲染”（Offscreen Rendering）指的是渲染过程在屏幕缓冲区之外的另一个缓冲区中完成，然后将结果拷贝回主屏幕缓冲区。这个过程通常需要更多的内存和处理时间，因为系统必须创建和操作额外的缓冲区。

### 哪些操作会引起离屏渲染

离屏渲染通常由以下几种操作触发：

1. **圆角 (Corner Radius)**：当设置 `layer.cornerRadius` 属性并需要裁剪内容（即 `layer.masksToBounds = YES` 时）。
2. **遮罩 (Mask)**：当给视图的 `layer.mask` 属性设置了一个遮罩图层。
3. **阴影 (Shadow)**：当使用 `layer.shadow*` 系列属性（如 `layer.shadowOpacity`、`layer.shadowOffset`、`layer.shadowRadius` 等）并且视图有裁剪或圆角时。
4. **图层混合 (Alpha and Blending)**：当设置 `layer.opacity`、`layer.compositeFilter` 等混合特效时。
5. **光栅化 (Rasterization)**：当开启 `layer.shouldRasterize = YES` 时。

### 为什么会出现离屏渲染

离屏渲染的出现有几个根本原因：

1. **复杂的绘制操作**：一些图层操作涉及裁剪、遮罩、阴影处理等，直接在主屏幕缓冲区中渲染难以实现或者性能较差，所以系统需要一个额外的缓冲区来先进行这些复杂操作。
2. **优化显示效果**：某些效果需要预先计算好再显示到屏幕上，这样能减少实时计算的开销。但这会牺牲内存和初次计算时间。
3. **提高缓存效率**：有时候多次重复的复杂绘制操作可以在离屏缓冲区预先计算好，后续再多次重用，从而提高性能。

### 应对离屏渲染的问题

1. **尽量避免对大视图设置 `masksToBounds` 和 `cornerRadius`**：能用图片代替或者调节视图层级来解决。
2. **单层优化**：尽量将复杂绘制操作限制在单一图层而不是多层叠加，减少每次离屏渲染的开销。
3. **光栅化的正确使用**：对于开销较大且相对静态的内容，可以开启 `shouldRasterize` 并调节合适的 `rasterizationScale`。
4. **减少透明视图的叠加**：合理使用 `opaque` 属性，减少 `alpha` 视图层级的过多重叠。

通过这些优化技巧，可以尽可能地减少离屏渲染，提升应用的性能。离屏渲染虽然有其必要性，但应尽量避免或控制其使用，特别是在复杂界面和动画中。